module Api
  module V1
    class ReviewsController < ApplicationController
      before_action :authenticate_user!
      before_action :set_booking, only: [:create]

      def index
        reviews = Review.includes(:reviewer, :reviewee)
                       .where(reviewee_id: params[:user_id])
                       .order(created_at: :desc)
        
        render json: reviews.as_json(
          include: {
            reviewer: { only: [:id, :name, :email] }
          },
          methods: [:trip_info]
        )
      end

      def create
        reviewee = determine_reviewee
        
        unless reviewee
          render json: { error: "Invalid reviewee for this booking" }, status: :unprocessable_entity
          return
        end

        review = Review.new(
          booking: @booking,
          reviewer: current_user,
          reviewee: reviewee,
          rating: review_params[:rating],
          comment: review_params[:comment]
        )

        if review.save
          render json: review.as_json(
            include: {
              reviewer: { only: [:id, :name, :email] },
              reviewee: { only: [:id, :name, :email] }
            }
          ), status: :created
        else
          render json: { errors: review.errors.full_messages }, status: :unprocessable_entity
        end
      end

      def booking_reviews
        @booking = Booking.find(params[:booking_id])
        reviews = @booking.reviews.includes(:reviewer, :reviewee)
        
        render json: reviews.as_json(
          include: {
            reviewer: { only: [:id, :name, :email] },
            reviewee: { only: [:id, :name, :email] }
          }
        )
      rescue ActiveRecord::RecordNotFound
        render json: { error: "Booking not found" }, status: :not_found
      end

      private

      def set_booking
        @booking = Booking.find(params[:booking_id])
        
        unless @booking.status == 'confirmed'
          render json: { error: "Can only review confirmed bookings" }, status: :unprocessable_entity
          return
        end
        
        trip = @booking.trip
        unless current_user.id == trip.driver_id || current_user.id == @booking.user_id
          render json: { error: "Forbidden - You are not part of this booking" }, status: :forbidden
        end
      rescue ActiveRecord::RecordNotFound
        render json: { error: "Booking not found" }, status: :not_found
      end

      def determine_reviewee
        trip = @booking.trip
        if current_user.id == trip.driver_id
          @booking.user
        elsif current_user.id == @booking.user_id
          trip.driver
        else
          nil
        end
      end

      def review_params
        params.require(:review).permit(:rating, :comment)
      end

      def authenticate_user!
        token = request.cookies["jwt"]
        payload = JwtService.decode(token)

        if payload
          @current_user = User.find_by(id: payload["user_id"] || payload[:user_id])
          render json: { error: "Unauthorized" }, status: :unauthorized unless @current_user
        else
          render json: { error: "Unauthorized" }, status: :unauthorized
        end
      end

      def current_user
        @current_user
      end
    end
  end
end
